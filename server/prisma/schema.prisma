// Prisma Schema for NotebookPro
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://onur@localhost:5432/notebookpro?schema=public"
}

// =====================
// USER & AUTHENTICATION
// =====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          UserRole  @default(CUSTOMER)
  isApproved    Boolean   @default(false)
  isActive      Boolean   @default(true)
  
  // Company details for B2B
  companyTitle  String?
  taxOffice     String?
  taxNumber     String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  orders        Order[]
  repairs       Repair[]
  reviews       Review[]
  favorites     Favorite[]
  notifications Notification[]
  refreshTokens RefreshToken[]
  addresses     Address[]
  
  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  fullName    String
  phone       String
  city        String
  district    String
  address     String
  postalCode  String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  orders      Order[]
  
  @@index([userId])
}

enum UserRole {
  ADMIN
  TECHNICIAN
  DEALER
  CUSTOMER
}

// =====================
// PRODUCTS
// =====================

model Product {
  id                    String          @id @default(uuid())
  sku                   String          @unique
  name                  String
  description           String?
  category              ProductCategory
  priceUsd              Float
  vatRate               Float           @default(0.20)
  stock                 Int             @default(0)
  criticalLimit         Int             @default(5)
  dealerDiscountPercent Float           @default(0)
  shelfLocation         String?
  imageUrl              String?
  isActive              Boolean         @default(true)
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  compatibleModels      CompatibleModel[]
  reviews               Review[]
  orderItems            OrderItem[]
  repairParts           RepairPart[]
  stockMovements        StockMovement[]
  favorites             Favorite[]
  
  @@index([sku])
  @@index([category])
  @@index([isActive])
}

model CompatibleModel {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  modelName String
  
  @@index([productId])
  @@index([modelName])
}

model StockMovement {
  id          String        @id @default(uuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  type        StockMoveType
  quantity    Int
  reason      String?
  performedBy String?
  createdAt   DateTime      @default(now())
  
  @@index([productId])
  @@index([createdAt])
}

model Review {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([userId, productId])
  @@index([userId])
}

enum ProductCategory {
  SCREEN
  BATTERY
  KEYBOARD
  CHIPSET
  RAM
  STORAGE
  MOTHERBOARD
}

enum StockMoveType {
  IN
  OUT
  ADJUSTMENT
}

// =====================
// ORDERS
// =====================

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  addressId       String?
  address         Address?      @relation(fields: [addressId], references: [id])
  status          OrderStatus   @default(PENDING)
  
  subtotal        Float
  vatAmount       Float
  discount        Float         @default(0)
  shippingCost    Float         @default(0)
  totalAmount     Float
  
  couponCode      String?
  couponDiscount  Float         @default(0)
  
  isGiftWrapped   Boolean       @default(false)
  giftMessage     String?
  
  paymentMethod   String?
  paymentStatus   PaymentStatus @default(PENDING)
  
  trackingNumber  String?
  carrier         String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  customerNote    String?
  adminNote       String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  items           OrderItem[]
  statusHistory   OrderStatusHistory[]
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  
  @@index([orderId])
  @@index([productId])
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  note      String?
  createdBy String?
  createdAt DateTime    @default(now())
  
  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// =====================
// REPAIRS / SERVICE
// =====================

model Repair {
  id                String         @id @default(uuid())
  trackingCode      String         @unique
  userId            String?
  user              User?          @relation(fields: [userId], references: [id])
  
  customerName      String
  customerPhone     String
  customerEmail     String?
  
  deviceBrand       String
  deviceModel       String
  serialNumber      String?
  
  issueDescription  String
  technicianNotes   String?
  
  status            RepairStatus   @default(RECEIVED)
  priority          RepairPriority @default(NORMAL)
  
  estimatedCost     Float?
  finalCost         Float?
  isPaid            Boolean        @default(false)
  
  warrantyStatus    WarrantyStatus?
  warrantyNotes     String?
  
  technicianId      String?
  
  receivedAt        DateTime       @default(now())
  diagnosedAt       DateTime?
  repairedAt        DateTime?
  deliveredAt       DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  parts             RepairPart[]
  statusHistory     RepairStatusHistory[]
  
  @@index([trackingCode])
  @@index([userId])
  @@index([status])
  @@index([customerPhone])
}

model RepairPart {
  id        String  @id @default(uuid())
  repairId  String
  repair    Repair  @relation(fields: [repairId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Float
  
  @@index([repairId])
  @@index([productId])
}

model RepairStatusHistory {
  id        String       @id @default(uuid())
  repairId  String
  repair    Repair       @relation(fields: [repairId], references: [id], onDelete: Cascade)
  status    RepairStatus
  note      String?
  createdBy String?
  createdAt DateTime     @default(now())
  
  @@index([repairId])
}

enum RepairStatus {
  RECEIVED
  DIAGNOSING
  WAITING_PARTS
  WAITING_APPROVAL
  IN_REPAIR
  QUALITY_CHECK
  READY
  DELIVERED
  CANCELLED
}

enum RepairPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum WarrantyStatus {
  PENDING
  APPROVED
  REJECTED
  SENT_TO_SUPPLIER
  RETURNED
}

// =====================
// NOTIFICATIONS
// =====================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  ORDER
  REPAIR
  STOCK
  SYSTEM
  PROMOTION
}

// =====================
// COUPONS
// =====================

model Coupon {
  id            String     @id @default(uuid())
  code          String     @unique
  type          CouponType
  value         Float
  minPurchase   Float?
  maxDiscount   Float?
  usageLimit    Int?
  usedCount     Int        @default(0)
  validFrom     DateTime   @default(now())
  validUntil    DateTime
  isActive      Boolean    @default(true)
  description   String?
  categories    String[]   // PostgreSQL array support
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  @@index([code])
  @@index([isActive])
}

enum CouponType {
  PERCENTAGE
  FIXED
}

// =====================
// SETTINGS
// =====================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
}
